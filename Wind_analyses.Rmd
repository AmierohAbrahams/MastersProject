---
title: "Wind_analyses"
author: "Amieroh Abrahams"
date: "18 February 2019"
output: html_document
---

# Script Info
The aim of this script is to plot wind rose diagrams and wavelets representing the wind for the sites which correspond with the upwelling sites along the west coast of South Africa. Using this we will be able to make deductions as to whether or not the intensity and duration of upwelling varied as a result of wind patterns. *Latest wind data on line 149*

The wind data used in this analyses were obtained from the SAWS  *Other wind datasets still to be used*

# Libraries

First I need to find, install and load various packages. These packages will be available on CRAN and can be accessed and installed in the usual way.

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(ggpubr)
library(lubridate)
library(stringr)
library(circular)
library(broom)
library(purrr)
library(stlplus)
library(zoo)
source("functions/wind.rose.R")
```


## Wind and wave data obtained from SAWS

Creating a function to load the wind and wave data:

```{r define_fun8, include=TRUE}
# Building the  function (file path): data/wave_data/Sea Point/15m_359.txt
#                          1/   2     /    3    /     4

load_wave <- function(wave_files) {
  site_name <- sapply(strsplit(as.character(wave_files), "/"), "[[", 3)
  site_info <- sapply(strsplit(as.character(wave_files), "/"), "[[", 4)
  site_info <- sapply(strsplit(site_info, ".txt"), "[[", 1)
  site_info <- strsplit(site_info, "_")
  site_depth <- sapply(site_info, "[[", 1)
  site_num <- sapply(site_info, "[[", 2)
  
  wave <- read_table(wave_files, col_types = c("dddddd"),
                     col_names = c("date", "hs", "tp", "dir", "dirw", "spw")) %>%
    filter(tp != -999) %>%
    mutate(date = as.POSIXct(as.character(date), "%Y%m%d%H%M", tz = "Africa/Johannesburg")) %>%
    mutate(site = site_name,
           num = site_num,
           depth = site_depth) %>%
    select(site, num, depth, everything()) %>%
    na.omit()
  return(wave)
}

sea_point <- map_dfr(dir("Data/wave_data/Sea Point", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
lamberts_bay <- map_dfr(dir("Data/wave_data/Lamberts Bay", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
port_nolloth <- map_dfr(dir("Data/wave_data/Port Nolloth", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
saldanha_bay <- map_dfr(dir("Data/wave_data/Saldanha Bay",
                        full.names = TRUE, pattern = "*.txt"), load_wave)

wave_data <- rbind(sea_point,lamberts_bay,port_nolloth,saldanha_bay)
rm(sea_point,lamberts_bay,port_nolloth,saldanha_bay)
```

Converting the 3-hour resolution wave data into daily data. https://cran.r-project.org/web/packages/circular/circular.pdf (Pg 130). The circular function creates circular objects around the wind and wave direction. The wave and wind direction was collected every three hours and by using the circular function we calcuated the daily mean wave and wind direction. There is a numerically large gap between 360 and 2 where as in degrees its not as large. The circular mean function returns the mean direction of a vector of circular data. Here I also split the daily wave data into depths of 7m and 15m respectivley. For this analyses I will only be working with 7m analyses. 

```{r}
wave_daily_dir <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean.circular(circular(dir, units = "degrees")),
            dirw_circ = mean.circular(circular(dirw, units = "degrees"))) 
wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = T) %>%
  ungroup() %>% 
  left_join(wave_daily_dir)
# save(wave_daily, file = "Data/wave_daily.RData")

load("~/Documents/Masters_2019/MastersProject/Data/wave_daily.RData")
wave_data_7 <- wave_daily %>%
  filter(depth == "7m")
# wave_date_15 <- wave_data %>%
#   filter(depth == "15m")
```

```{r}
load("Data/temp_2014_2015/G1SST_fyears.RData")
load("Data/temp_2014_2015/OISST_fyears.RData")
load("Data/temp_2014_2015/MUR_fyears.RData")
load("Data/temp_2014_2015/SACTN_fyears.RData")
load("Data/temp_2014_2015/K10_fyears.RData")
```

#############################################################
#############################################################
This following code is unable to plot the wind patterns (wind roses) as temperature collection occured between 2014-2015 and we do not have wind data that corresponds with these years 

Here I match the wind data with the SST datasets

```{r}
match_wave_7 <- function(df) {
  func1 <- df %>% 
    left_join(wave_data_7, by = c("site", "date")) %>% 
    na.trim() %>% 
    group_by(site)
    return(func1)
}

MUR_wind <- match_wave_7(df = MUR_fyears)
SACTN_wind <-  match_wave_7(df = SACTN_fyears)
OISST_wind <-  match_wave_7(df = OISST_fyears)
G1SST_wind <-  match_wave_7(df = G1SST_fyears)
# K10_wind <-  match_wave_7(df = overlap_ts)
```

# Wind rose diagrams plotting the wind action 

```{r}
source("functions/wind.rose.R")

wave_daily_renamed <- MUR_wind %>% 
  dplyr::rename(spd = spw_mean) %>%
  dplyr::rename(dir = dirw_mean)

p.wr2 <- plot.windrose(data = wave_daily_renamed,
              spd = "spd",
              dir = "dir")

p.wr3 <- p.wr2 + facet_wrap(~ site) +
  theme(strip.text.x = element_text(size = 20))
p.wr3

```
#############################################################
#############################################################

## Writing a funciton to load the new wind data


```{r define_fun8, include=TRUE}
# load_wind <- function(wind_files) {
#  site_info <- sapply(strsplit(as.character(wind_files), "/"), "[[", 4)
#  site_info <- sapply(strsplit(site_info, ".txt"), "[[", 1)
#   
#   wave <- read_table(wind_files, col_types = c("dddddd"),
#                      col_names = c("station_number", "station_name", "date", "hour", "speed", "dir")) %>% 
#        na.omit()
#   return(wave)
# }
# 
# tester <- map_dfr(dir("Data/wind_data.txt(SAWS)/wind1", 
#                             full.names = TRUE, pattern = "*.txt"), load_wind)


wind_1 <- read.delim("/home/amieroh/Documents/Masters_2019/MastersProject/Data/wind_data.txt(SAWS)/wind1/wind1.txt", na.strings="") 
colnames(wind_1) <- c("station_number", "station_name", "date", "hour", "sub", "speed", "dir") 

wind_2 <- read.delim("/home/amieroh/Documents/Masters_2019/MastersProject/Data/wind_data.txt(SAWS)/wind2/wind2.txt", na.strings="")
colnames(wind_2) <- c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir")

wind_3 <- read.delim("/home/amieroh/Documents/Masters_2019/MastersProject/Data/wind_data.txt(SAWS)/wind3/wind3.txt", na.strings="")
colnames(wind_3) <- c("station_number", "station_name", "date", "hour", "sub" ,"speed", "dir")

# Slecting the important columns for each of the datasets
wind_fix <- function(df){
wind <- df%>% 
  select(station_name, date, hour, dir, speed)
}

wind_1 <- wind_fix(df = wind_1)
wind_2 <- wind_fix(df = wind_2)
wind_3 <- wind_fix(df = wind_3)

## Renaming the sites within the wind datasets to match the name of the sites at which seawater temperature was collected
## The wind data was obtained from the SAWS and the wind stations used were the closes stations to which temperature was collected

renaming_sites_1 <- function(df) {
  sites <- df %>%
    mutate(temp_sites = ifelse(station_name %in% c("CAPE COLUMBINE"), "St Helena Bay",        
                           ifelse(station_name %in% c("KOINGNAAS"), "Hondeklipbaai",
                                ifelse(station_name %in% c("PORT NOLLOTH"), "Port Nolloth",
                                       ifelse(station_name %in% c("LAMBERTSBAAI NORTIER"), "Lamberts Bay",
                                              ifelse(station_name %in% c("LANGEBAANWEG AWS"), "Saldanha Bay
","Error"))))))
  return(sites)
}

wind_sitesmatched_1 <-  renaming_sites_1(df = wind_1)
wind_sitesmatched_1 <- wind_sitesmatched_1[-c(121352, 121353, 379892, 379893, 609324, 609325, 843506, 843507, 1014585), ] 

renaming_sites_2 <- function(df) {
  sites <- df %>%
    mutate(temp_sites = ifelse(station_name %in% c("ROBBENEILAND"), "Koeberg Basin",        
                           ifelse(station_name %in% c("GEELBEK"), "Yzerfontein",
                                ifelse(station_name %in% c("DASSEN ISLAND"), "Dassen Island",
                                       ifelse(station_name %in% c("ATLANTIS"), "Koeberg Basin","Error")))))
  return(sites)
}

wind_sitesmatched_2 <-  renaming_sites_2(df = wind_2)
wind_sitesmatched_2 <- wind_sitesmatched_2[-c(228372, 228373, 313441, 313442, 364881, 364882, 557392), ] 

renaming_sites_3 <- function(df) {
  sites <- df %>%
    mutate(temp_sites = ifelse(station_name %in% c("CAPE TOWN SLANGKOP"), "Kommetjie",  
                           ifelse(station_name %in% c("CAPE TOWN - ROYAL YACHT CLUB"), "Sea Point",
                           ifelse(station_name %in% c("CAPE TOWN TABLE BAY"), "Sea Point","Error"))))
  return(sites)
}

wind_sitesmatched_3 <-  renaming_sites_3(df = wind_3)
wind_sitesmatched_3 <- wind_sitesmatched_3[-c(119317, 119318, 196551, 196552, 346759), ] 

## CAPE TOWN SLANGKOP may be used for Kommetjie and for Houtbay
wind_3_HoutBay <- wind_3 %>% 
  filter(station_name == "CAPE TOWN SLANGKOP") %>% 
  mutate(temp_sites = ifelse(station_name %in% c("CAPE TOWN SLANGKOP"), "Hout Bay","Error"))

wind_data <- rbind(wind_3_HoutBay,wind_sitesmatched_3,wind_sitesmatched_2,wind_sitesmatched_1)
wind_data <- wind_data %>% 
  dplyr::rename(site = temp_sites) %>% 
  select(site, date, hour, dir, speed)
```

Things to do*******

- Match temp and wind data
- Create plots shwoing predominant wind direction during an upwelling evnt











