---
title: "Geostrophic currents"
author: "Amieroh Abrahams"
date: "20 March 2019"
output: html_document
---

Geostrophic current:
- Oceanic current in which the pressure gradient force is balanced by the coriolis effect
- Direction of geostrophic flows is parallel to the isobars
- Use AVISO data
- u and v values

## Extracting the AVISO data

```{r}
library(ncdf4) 
library(data.table) 
library(tidyverse) 
library(reshape2) 
library(plyr) 
library(lubridate)
library(stringr)

nc.dir <- "/home/amieroh/Documents/spatial/test/netCDF"
csv.dir <- "/home/amieroh/Documents/spatial/test/csv"

#          1         2         3         4         5         6        
# 1234567890123456789012345678901234567890123456789012345678901234567890
# dataset-duacs-rep-global-merged-allsat-phy-l4-v3_19930101-19951231.nc

ncread <- function(nc.dir = nc.dir, csv.dir = dir){
  nc.files <- list.files(path = nc.dir, pattern = "*.nc", full.names = T, include.dirs = T)
  strt.date <- str_sub(basename(nc.files[1]), start = 51, end = 66)
  end.date <- str_sub(basename(nc.files[length(nc.files)]), start = 51, end = 66)
  nc.file <- nc.files[1]
  ncFun <- function(nc.file = nc.files, csv.dir = csv.dir) {
    nc <- nc_open(nc.file)
    name.stem <- substr(basename(nc.file), 1, 48) 
    date.stamp <- substr(basename(nc.file), 51, 66)
    ugos <- ncvar_get(nc, varid = "ugos") %>%
      round(4)
    dimnames(ugos) <- list(lon = nc$dim$lon$vals,
                           lat = nc$dim$lat$vals,
                           time = nc$dim$time$vals)
    sla <-
      as.tibble(melt(ugos, value.name = "ugos"), row.names = NULL) %>%
      dplyr::mutate(vgos = as.vector(ncvar_get(nc, varid = "vgos")),
                    adt = as.vector(ncvar_get(nc, varid = "adt")),
                    sla = as.vector(ncvar_get(nc, varid = "sla"))) %>%
      dplyr::mutate(time = as.Date(time, origin = "1950-01-01 00:00:00")) %>%
      na.omit()
    nc_close(nc)
    fwrite(sla,
           file = paste0(csv.dir, name.stem, "-", strt.date, "-", end.date, ".csv"),
           append = TRUE, col.names = FALSE)
    rm(sla)
  }
  llply(nc.files, ncFun, csv.dir = csv.dir, .parallel = FALSE)
}

ncread(nc.dir, csv.dir)
```

## Loading the AVISO data

```{r}

AVISODir <- "~/Documents/Masters_2019/Data_SST"
AVISO <- fread(paste0(AVISODir, "/csvdataset-duacs-rep-global-merged-allsat-phy-l4-v3-9930101-19951231-0160101-20170515.csv"),
            col.names = c("lon", "lat", "time", "u", "v", "sla", "adt"))

AVISO <- AVISO %>%
  dplyr::group_by(lon, lat) %>%
  dplyr::summarise(u = mean(u, na.rm = TRUE),
                   v = mean(v, na.rm = TRUE),
                   mean.adt = mean(adt, na.rm = TRUE),
                   mean.sla = mean(sla, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(velocity = sqrt((v^2) + (u^2)),
                eke = 0.5 * (u^2 + v^2),
                arrow_size = ((abs(u * v) / max(abs(u * v))) + 0.3) / 6)

save(AVISO, file = "Data/AVISO.RData")
```

